<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="org.code.privateclinic.mapper.MedicalCaseMapper">
    
    <!-- 查询所有病例列表 -->
    <select id="getMedicalCaseList" resultType="org.code.privateclinic.bean.MedicalCase">
        SELECT
            mc.case_id AS caseId,
            mc.patient_id AS patientId,
            p.patient_name AS patientName,
            mc.doctor_id AS doctorId,
            u.user_name AS doctorName,
            mc.symptom,
            mc.diagnosis,
            mc.case_status AS caseStatus,
            mc.visit_time AS visitTime,
            mc.create_time AS createTime,
            mc.update_time AS updateTime
        FROM medical_case mc
        LEFT JOIN patient p ON mc.patient_id = p.patient_id
        LEFT JOIN user u ON mc.doctor_id = u.user_id
        ORDER BY mc.create_time DESC
    </select>

    <!-- 根据ID查询病例 -->
    <select id="getMedicalCaseById" resultType="org.code.privateclinic.bean.MedicalCase">
        SELECT
            mc.case_id AS caseId,
            mc.patient_id AS patientId,
            p.patient_name AS patientName,
            mc.doctor_id AS doctorId,
            u.user_name AS doctorName,
            mc.symptom,
            mc.diagnosis,
            mc.case_status AS caseStatus,
            mc.visit_time AS visitTime,
            mc.create_time AS createTime,
            mc.update_time AS updateTime
        FROM medical_case mc
        LEFT JOIN patient p ON mc.patient_id = p.patient_id
        LEFT JOIN user u ON mc.doctor_id = u.user_id
        WHERE mc.case_id = #{caseId}
    </select>

    <!-- 根据患者ID查询病例列表 -->
    <select id="getMedicalCaseByPatientId" resultType="org.code.privateclinic.bean.MedicalCase">
        SELECT
            mc.case_id AS caseId,
            mc.patient_id AS patientId,
            p.patient_name AS patientName,
            mc.doctor_id AS doctorId,
            u.user_name AS doctorName,
            mc.symptom,
            mc.diagnosis,
            mc.case_status AS caseStatus,
            mc.visit_time AS visitTime,
            mc.create_time AS createTime,
            mc.update_time AS updateTime
        FROM medical_case mc
        LEFT JOIN patient p ON mc.patient_id = p.patient_id
        LEFT JOIN user u ON mc.doctor_id = u.user_id
        WHERE mc.patient_id = #{patientId}
        ORDER BY mc.create_time DESC
    </select>

    <!-- 根据医生ID查询病例列表 -->
    <select id="getMedicalCaseByDoctorId" resultType="org.code.privateclinic.bean.MedicalCase">
        SELECT
            mc.case_id AS caseId,
            mc.patient_id AS patientId,
            p.patient_name AS patientName,
            mc.doctor_id AS doctorId,
            u.user_name AS doctorName,
            mc.symptom,
            mc.diagnosis,
            mc.case_status AS caseStatus,
            mc.visit_time AS visitTime,
            mc.create_time AS createTime,
            mc.update_time AS updateTime
        FROM medical_case mc
        LEFT JOIN patient p ON mc.patient_id = p.patient_id
        LEFT JOIN user u ON mc.doctor_id = u.user_id
        WHERE mc.doctor_id = #{doctorId}
        ORDER BY mc.create_time DESC
    </select>

    <!-- 根据状态查询病例列表 -->
    <select id="getMedicalCaseByStatus" resultType="org.code.privateclinic.bean.MedicalCase">
        SELECT
            mc.case_id AS caseId,
            mc.patient_id AS patientId,
            p.patient_name AS patientName,
            mc.doctor_id AS doctorId,
            u.user_name AS doctorName,
            mc.symptom,
            mc.diagnosis,
            mc.case_status AS caseStatus,
            mc.visit_time AS visitTime,
            mc.create_time AS createTime,
            mc.update_time AS updateTime
        FROM medical_case mc
        LEFT JOIN patient p ON mc.patient_id = p.patient_id
        LEFT JOIN user u ON mc.doctor_id = u.user_id
        WHERE mc.case_status = #{caseStatus}
        ORDER BY mc.create_time DESC
    </select>

    <!-- 插入病例 -->
    <insert id="addMedicalCase" parameterType="org.code.privateclinic.bean.MedicalCase" useGeneratedKeys="true" keyProperty="caseId">
        INSERT INTO medical_case (
            patient_id,
            doctor_id,
            symptom,
            diagnosis,
            case_status,
            visit_time
        ) VALUES (
            #{patientId},
            #{doctorId},
            #{symptom},
            #{diagnosis},
            #{caseStatus},
            #{visitTime}
        )
    </insert>

    <!-- 更新病例信息 -->
    <update id="updateMedicalCase" parameterType="org.code.privateclinic.bean.MedicalCase">
        UPDATE medical_case
        <set>
            <if test="patientId != null">
                patient_id = #{patientId},
            </if>
            <if test="doctorId != null">
                doctor_id = #{doctorId},
            </if>
            <if test="symptom != null">
                symptom = #{symptom},
            </if>
            <if test="diagnosis != null">
                diagnosis = #{diagnosis},
            </if>
            <if test="caseStatus != null and caseStatus != ''">
                case_status = #{caseStatus},
            </if>
            <if test="visitTime != null">
                visit_time = #{visitTime},
            </if>
        </set>
        WHERE case_id = #{caseId}
    </update>

    <!-- 删除病例 -->
    <delete id="deleteMedicalCase">
        DELETE FROM medical_case
        WHERE case_id = #{caseId}
    </delete>

</mapper>

